version: "3"

includes:
  checksum: "checksum.yaml"
  remote: "remote.yaml"

set: ["u", "pipefail"]
shopt: ["globstar"]

tasks:
  # Copy the `SOURCE_DIR` into `BUILD_DIR`. Run `bootstrap.sh` to generate the `b2` build tool
  # and `project-config.jam` file in the build directory. Run `b2` to build Boost.
  #
  # @param {string} SOURCE_DIR Project source directory.
  # @param {string} BUILD_DIR Directory in which to build the project.
  # @param {string} INSTALL_PREFIX Path prefix of where the project should be installed.
  # @param {string[]} TARGETS Target libraries to build.
  # @param {string} BUILD_CHECKSUM The checksum of the build directory.
  # @param {string[]} [BOOTSTRAP_ARGS] Any additional arguments to pass to running `bootstrap.sh`.
  # @param {string[]} [BUILD_ARGS] Any additional arguments to pass to building Boost.
  # @param {int} [JOBS] The maximum number of concurrent processes to use when building. If
  # omitted, the b2 default number is used. Before 1.76.0, the number was 1. Since 1.76.0, the
  # default is the number of cores.
  build:
    internal: true
    dir: "{{.BUILD_DIR}}"
    vars:
      EXTRA_ARGS:
        ref: "default (list) .EXTRA_ARGS"
    requires:
      vars: ["SOURCE_DIR", "BUILD_DIR", "INSTALL_PREFIX", "TARGETS", "BUILD_CHECKSUM"]
    sources:
      - "{{.SOURCE_DIR}}/**/*"
    generates:
      - "{{.BUILD_CHECKSUM}}"
    deps:
      - task: "checksum:validate"
        vars:
          CHECKSUM_FILE: "{{.BUILD_CHECKSUM}}"
          INCLUDE_PATTERNS:
            - "{{.BUILD_DIR}}"
    cmds:
      - >-
        rm -rf "{{.BUILD_DIR}}/*"
      - >-
        cp -R "{{.SOURCE_DIR}}"/* "{{.BUILD_DIR}}/"
      - >-
        ./bootstrap.sh
        --prefix="{{.INSTALL_PREFIX}}"
        --exec-prefix="{{.INSTALL_PREFIX}}"
        --with-libraries={{(join "," .TARGETS)}}
        {{- range .BOOSTRAP_ARGS}}
          "{{.}}"
        {{- end}}
      - >-
        ./b2
        {{- range .BUILD_ARGS}}
          "{{.}}"
        {{- end}}
        {{- if .JOBS}}
          "-j{{.JOBS}}"
        {{- end}}
      - task: "checksum:compute"
        vars:
          CHECKSUM_FILE: "{{.BUILD_CHECKSUM}}"
          INCLUDE_PATTERNS:
            - "{{.BUILD_DIR}}"

  # Runs the b2 install step for boost. The caller must have previously called `build` on
  # `BUILD_DIR` for this task to succeed. If `CMAKE_SETTINGS_DIR` is set, a settings file will be
  # created in that directory, containing a `boost_ROOT` CMake variable that points to
  # `INSTALL_PREFIX`.
  #
  # @param {string} BUILD_DIR Directory containing the boost source.
  # @param {string} INSTALL_PREFIX Path prefix of where the project should be installed.
  # @param {string} BUILD_CHECKSUM The checksum of the build directory.
  # @param {string} INSTALL_CHECKSUM The checksum of the install directory and `boost.cmake`.
  # @param {string} [CMAKE_SETTINGS_DIR] If set, the directory where the project's CMake settings
  # file should be stored.
  # @param {string[]} [EXTRA_ARGS] Any additional arguments to pass to the install command.
  install:
    internal: true
    dir: "{{.BUILD_DIR}}"
    vars:
      EXTRA_ARGS:
        ref: "default (list) .EXTRA_ARGS"
      INSTALL_PREFIX: >-
        {{default "" .INSTALL_PREFIX}}
      CMAKE_SETTINGS_DIR: >-
        {{default "" .CMAKE_SETTINGS_DIR}}
    requires:
      vars: ["BUILD_DIR", "INSTALL_PREFIX", "BUILD_CHECKSUM", "INSTALL_CHECKSUM"]
    sources:
      - "{{.BUILD_CHECKSUM}}"
    generates:
      - "{{.INSTALL_CHECKSUM}}"
    deps:
      - task: "checksum:validate"
        vars:
          CHECKSUM_FILE: "{{.INSTALL_CHECKSUM}}"
          INCLUDE_PATTERNS:
            - "{{.INSTALL_PREFIX}}"
            - "{{.CMAKE_SETTINGS_DIR}}/boost.cmake"
    cmds:
      - >-
        ./b2
        install
        {{- range .EXTRA_ARGS}}
          "{{.}}"
        {{- end}}
      - >-
        {{- if .CMAKE_SETTINGS_DIR}}
          echo "set(Boost_ROOT
            \"{{.INSTALL_PREFIX}}\"
            CACHE PATH
            \"Package root for boost.\"
          )" >> "{{.CMAKE_SETTINGS_DIR}}/boost.cmake"
        {{- end}}
      - task: "checksum:compute"
        vars:
          CHECKSUM_FILE: "{{.INSTALL_CHECKSUM}}"
          INCLUDE_PATTERNS:
            - "{{.INSTALL_PREFIX}}"
            - "{{.CMAKE_SETTINGS_DIR}}/boost.cmake"

  # Downloads boost from `URL` and installs boost.
  #
  # General parameters
  # @param {string} [WORK_DIR={{.ROOT_DIR}}] Base directory to store the src, build and install
  # directories inside.
  # @param {string} [SOURCE_DIR={{.WORK_DIR}}/boost-src] Directory in which to extract the tar
  # file.
  # @param {string} [BUILD_DIR={{.WORK_DIR}}/boost-build] Directory in which to build the project.
  #
  # Download parameters
  # @param {string} FILE_SHA256 Content hash to verify the downloaded tar file against.
  # @param {string} URL
  #
  # Boost generate parameters
  # @param {string} [INSTALL_PREFIX={{.WORK_DIR}}/boost-install] Path prefix of where the project
  # should be installed.
  # @param {string[]} [TARGETS] Target libraries to build.
  # @param {string[]} [GEN_ARGS] Any additional arguments to pass to the generate command.
  #
  # Boost build parameters
  # @param {int} [JOBS] The maximum number of concurrent processes to use when building. If
  # omitted, the b2 default number is used. Before 1.76.0, the number was 1. Since 1.76.0, the
  # default is the number of cores.
  # @param {string[]} [BUILD_ARGS] Any additional arguments to pass to the build command.
  #
  # Boost install parameters
  # @param {string[]} [INSTALL_ARGS] Any additional arguments to pass to the install command.
  # @param {string} [CMAKE_SETTINGS_DIR] If set, the directory where the project's CMake settings
  # file should be stored.
  download-and-install:
    internal: true
    label: "{{.TASK}}:{{.URL}}-{{.INSTALL_PREFIX}}"
    vars:
      # General parameters
      WORK_DIR: >-
        {{default .ROOT_DIR .WORK_DIR}}
      SOURCE_DIR: >-
        {{default (printf "%s/boost-src" .WORK_DIR) .SOURCE_DIR}}
      BUILD_DIR: >-
        {{default (printf "%s/boost-build" .WORK_DIR) .BUILD_DIR}}

      # Boost build parameters
      INSTALL_PREFIX: >-
        {{default (printf "%s/boost-install" .WORK_DIR) .INSTALL_PREFIX}}
      TARGETS:
        ref: "default (list) .TARGETS"
      BOOTSTRAP_ARGS:
        ref: "default (list) .BOOTSTRAP_ARGS"
      BUILD_ARGS:
        ref: "default (list) .BUILD_ARGS"
      JOBS: >-
        {{default "" .JOBS}}
      BUILD_CHECKSUM: >-
        {{default (printf "%s/boost-build.md5" .WORK_DIR) .BUILD_CHECKSUM}}

      # Boost install parameters
      INSTALL_ARGS:
        ref: "default (list) .INSTALL_ARGS"
      CMAKE_SETTINGS_DIR: >-
        {{default "" .CMAKE_SETTINGS_DIR}}
      INSTALL_CHECKSUM: >-
        {{default (printf "%s/boost-install.md5" .WORK_DIR) .INSTALL_CHECKSUM}}
    requires:
      vars: ["FILE_SHA256", "URL"]
    deps:
      - task: "remote:download-and-extract-tar"
        vars:
          FILE_SHA256: "{{.FILE_SHA256}}"
          OUTPUT_DIR: "{{.SOURCE_DIR}}"
          URL: "{{.URL}}"
    cmds:
      - >-
        mkdir -p "{{.BUILD_DIR}}"
      - task: "build"
        vars:
          SOURCE_DIR: "{{.SOURCE_DIR}}"
          BUILD_DIR: "{{.BUILD_DIR}}"
          INSTALL_PREFIX: "{{.INSTALL_PREFIX}}"
          TARGETS:
            ref: ".TARGETS"
          JOBS: "{{.JOBS}}"
          BOOTSTRAP_ARGS:
            ref: ".BOOTSTRAP_ARGS"
          BUILD_ARGS:
            ref: ".BUILD_ARGS"
          BUILD_CHECKSUM: "{{.BUILD_CHECKSUM}}"
      - task: "install"
        vars:
          BUILD_DIR: "{{.BUILD_DIR}}"
          INSTALL_PREFIX: "{{.INSTALL_PREFIX}}"
          CMAKE_SETTINGS_DIR: "{{.CMAKE_SETTINGS_DIR}}"
          EXTRA_ARGS:
            ref: ".INSTALL_ARGS"
          BUILD_CHECKSUM: "{{.BUILD_CHECKSUM}}"
          INSTALL_CHECKSUM: "{{.INSTALL_CHECKSUM}}"
